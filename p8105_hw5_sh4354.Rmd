---
title: "Homework 5"
author: "Selina Hsuan"
date: '`r format(Sys.time(), "%Y-%m-%d")`'
output: github_document
---


## Problem 1

```{r setup, include=FALSE}
knitr::opts_chunk$set(collapse = TRUE, message = FALSE)
```

```{r}
library(tidyverse)
library(p8105.datasets)
```

Download and clean data 
```{r}
homicides_df = 
  read_csv("data/homicide-data.csv", na = c("", "NA", "Unknown")) |> 
  janitor::clean_names() |> 
  mutate(
    city_state = str_c(city, state, sep = ", "),
    resolution = case_when(
      disposition == "Closed without arrest" ~ "unsolved",
      disposition == "Open/No arrest"        ~ "unsolved",
      disposition == "Closed by arrest"      ~ "solved"
    )
  ) |> 
    filter(city_state != "Tulsa, AL") 
```


Homicides solved by city_state
```{r}
city_homicide_df = 
  homicides_df |> 
  select(city_state, disposition, resolution) |> 
  group_by(city_state) |> 
  summarize(
    hom_total = n(),
    hom_unsolved = sum(resolution == "unsolved"))
```

Proportion of homicides unsolved in Baltimore, MD
```{r}
bmore_test = 
  prop.test(
    x = filter(city_homicide_df, city_state == "Baltimore, MD") |>  pull(hom_unsolved),
    n = filter(city_homicide_df, city_state == "Baltimore, MD") |>  pull(hom_total)) 

broom::tidy(bmore_test) |> 
  knitr::kable(digits = 3)
```

Estimates and CI's for proportion of unsolved homicides in each city
```{r}
test_results = 
  city_homicide_df |> 
  mutate(
    prop_tests = map2(hom_unsolved, hom_total, \(x, y) prop.test(x = x, n = y)),
    tidy_tests = map(prop_tests, broom::tidy)) |> 
    select(-prop_tests) |> 
    unnest(tidy_tests) |> 
    select(city_state, estimate, conf.low, conf.high) |> 
    mutate(city_state = fct_reorder(city_state, estimate))
```

Create plot showing the estimate (and CI) of the proportion of unsolved homicides in each city
```{r}
test_results |> 
  mutate(city_state = fct_reorder(city_state, estimate)) |> 
  ggplot(aes(x = city_state, y = estimate)) + 
  geom_point() + 
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high)) + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```



## Problem 2

```{r}
list_participant = 
  list.files("data")
```

```{r}
read_data = function(file) {
  data = read_csv(paste0("data/", file))
  return(data)
}
```

```{r}
participant_df = 
  data.frame(file_name = list_participant) |> 
  mutate (data = map(file_name, read_data)) |> 
  unnest(data) |> 
  separate(file_name, into = c("study_arm", "subject_id"), sep = "_") |> 
  pivot_longer(week_1:week_8,
    names_to = "week", 
    values_to = "observation") |> 
  mutate(subject_id = str_replace(subject_id, ".csv", ""),
         week = str_replace(week, "week_", ""), 
         study_arm = case_when(
           study_arm == "con" ~ "control",
           study_arm == "exp" ~ "experimental"
         )) |> 
  mutate(subject_id_numeric = as.numeric(subject_id)) |> 
  mutate(subject_id_renumbered = case_when(
           study_arm == "experimental" ~ subject_id_numeric + 10,
           TRUE ~ subject_id_numeric))
```

```{r}
participant_df |> 
  ggplot(aes(x = week, y = observation, color = study_arm, group = subject_id_renumbered)) + 
  geom_line() +
  labs(title = "Study Results", 
        x = "Week",
        y = "Observation", 
       color = "Study Arm")
```

The spaghetti plot shows that longitudinal observations from Week 1 to Week 8 have higher values overall in the experimental arm compared to the control arm. There appears to be an upward trend in observation values for the experimental arm, while observation values for the control arm fluctuate around the same range. 

## Problem 3

Set seed for reproducibility
```{r}
set.seed(12345)
```

Set up design elements
```{r}
sim_mean_sd = function(n_obs=30, mu = 0, sigma = 5) {
  
  x = rnorm(n = n_obs, mean = mu, sd = sigma)
  
  t_test_result = t.test(x)
  
  t_test_tidy = broom::tidy(t_test_result)
  
  return(c(
    est = t_test_tidy |> pull(estimate), 
    p_val = t_test_tidy |> pull(p.value)
    ))
}
```

Generate 5000 datasets from model
```{r}
output = vector("list", length = 5000)

for (i in 1:5000) {
  
  output[[i]] = sim_mean_sd()
  
}

sim_results = 
  bind_rows(output)
```


```{r}

```


